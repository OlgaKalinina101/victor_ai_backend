[← Назад к README](../README.md)

---

<a name="auth"></a>

# Логика авторизации в проекте

В проекте нет классической регистрации/логина.  
Есть **демо-ключи** (`demo_key`), по которым Victor решает: «этот человек вообще имеет доступ или нет».

> ❗ Это не продакшен-авторизация. Такие подходы не используются в публичных сервисах на тысячи людей.  
> Но для моего use-case «я и мой круг» — это как раз ровно то, что надо.  

Обсуждаемые файлы (для dev, не разработчики - пока пропустите этот список):
1. `api/auth.py`
2. `infrastructure/database/demo_keys.json`

---

## Оглавление

- [Логика авторизации в проекте](#auth)
- [1. Как выдать себе доступ](#self-access)
- [2. `account_id` и `gender`](#account-id-and-gender)
- [3. Кто такой `creator` и зачем `test_user`](#creator-and-test-user)
- [4. Как выдать доступ другим людям](#access-to-others)
- [5. Итог](#auth-summary)

---

<a name="self-access"></a>

### 1. Как выдать себе доступ

По умолчанию, в проекте доступен пользователь по паролю 11111.

Если нужно добавить еще одного пользователя.

1. Откройте файл:

```text
infrastructure/database/demo_keys.json
```

2. Пропишите туда любой НОВЫЙ ключ через запятую (это может быть любая строка, любой длины и с любыми символами):

```json
{
  "demo_keys": [
    "11111",
    "e490f3.....012379"
  ]
}
```  

3. Запустите бэкенд и откройте веб-демку или Android-приложение.  
4. На экране авторизации вставьте **ровно этот же** ключ как «пароль» (если заходите сами в первый раз, то этот ключ - 11111).  
  
После этого:

* система проверит, что ключ есть в `demo_keys.json`,
* предложит вам выбрать `account_id` и `gender`.

---

<a name="account-id-and-gender"></a>

### 2. `account_id` и `gender`

После ввода ключа вы:

* придумываете себе `account_id` (любой строковый идентификатор);
* выбираете `gender` — `male` или `female`.

> Архитектурно поддерживается и `other`,
> но продумать всю логику для него «в одни руки» довольно тяжело,
> поэтому пока этот вариант отключён в UI.

При первой успешной авторизации создаётся запись в таблице `chat_meta`:

```python
class ChatMeta(Base):
    __tablename__ = "chat_meta"
    __table_args__ = (
        UniqueConstraint("demo_key", name="uq_chat_meta_demo_key"),
    )

    account_id = Column(String, primary_key=True)
    model = Column(String, default="deepseek-chat")
    trust_level = Column(Integer, default=0)
    raw_trust_score = Column(Integer, nullable=True)
    gender = Column(String, default="другое")
    relationship_level = Column(String, default="незнакомец")
    is_creator = Column(Boolean, default=False)
    demo_key = Column(String, nullable=True, index=True)
    trust_established = Column(Boolean, default=False)      # старая логика, сейчас не используется
    trust_test_completed = Column(Boolean, default=False)   # старая логика, сейчас не используется
    trust_test_timestamp = Column(String, nullable=True)    # старая логика, сейчас не используется
    last_updated = Column(String, nullable=True)
```

По умолчанию:

* модель — `deepseek-chat`,
* `trust_level = 0`,
* `relationship_level = "незнакомец"`,
* `is_creator = False`.

---

<a name="creator-and-test-user"></a>

### 3. Кто такой `creator` и зачем `test_user`

У проекта есть понятие **creator-аккаунта** — это тот, кому:

* доступны два экрана в разработке в Android-приложении;
* доступен **последний уровень trust**;
* включено сохранение сообщений напрямую в `debug_dataset.jsonl`.

Сейчас это реализовано очень просто:

* для creator всегда используется `account_id = "test_user"`;
* у этой записи в `ChatMeta` должно быть `is_creator = True`.

**Как это настроить:**

1. Добавьте себе демо-ключ в `demo_keys.json`, как описано выше, или возьмите существующий "11111".

2. Зайдите в веб-демо/приложение с этим ключом.

3. В качестве `account_id` укажите ровно:

   ```text
   test_user
   ```

4. После первой авторизации откройте `ChatMeta` через pgAdmin.

5. Найдите запись с `account_id = "test_user"`.

6. Поменяйте `is_creator` с `False` на `True`.

Готово: этот аккаунт будет считаться creator.

> Если вам не нравится имя `test_user` — вы свободны его переименовать.
> Просто найдите по коду все места, где это значение хардкодно используется,
> и замените на своё. В будущем планируется вынести `account_id` creator в `.env`,
> чтобы не жёстко зашивать его в код.

---

<a name="access-to-others"></a>

### 4. Как выдать доступ другим людям

Если вы хотите дать кому-то веб-демо или приложение:

1. Сгенерируйте для них отдельные ключи и добавьте в `demo_keys.json`:

   ```json
   {
     "demo_keys": [
       "e490f3cac0459.......",
       "d9572ab9dea.........",
       "09f27f35597........."
     ]
   }
   ```

2. Отправьте человеку его ключ и apk/ссылку на web демку.

3. Он зайдёт в web-демо/приложение:

   * введёт **свой** ключ,
   * выберет свой `account_id` и `gender`.

У него:

* создастся своя запись в `ChatMeta`,
* `is_creator` останется `False`,
* trust будет расти по общим правилам.

Вы при этом:

* не видите его диалоги,
* можете при желании посмотреть метрики (например, `trust_level`),
  если лезете в базу руками.

---

<a name="auth-summary"></a>

### 5. Итог

* Авторизация в проекте — это:

  * **демо-ключ** → доступ вообще,
  * `account_id` → идентификатор конкретного пользователя,
  * `is_creator` → включает «режим создателя» и дополнительные возможности.
* Пароль/логин в привычном смысле здесь не нужен:
  доступ полностью контролируется через `demo_keys.json` и настройки в БД.

