да, это хорошая идея. counters уже «меряют» тип дыхания диалога — из них можно собрать:

1. \#интенсивность (dialog\_weight),
2. \#плотность (density),
3. \#сигналы насыщения/застревания (saturation) → когда мягко переключать режим.

ниже — рабочие, простые метрики + код-скелеты, которые можно вставить в твой контекст без ломки архитектуры.

---

# 1) dialog\_weight — «насколько эмоционально нагрето сейчас»

Идея: у каждого bucket — свой вклад в «нагрев». Считаем средневзвешенно за последние `W` ходов.

```python
from collections import deque, Counter
import math

# веса можно крутить под вкус
BUCKET_WEIGHTS = {
    "hug_count": 0.6,
    "support_count": 0.7,
    "resonance_count": 0.9,   # глубокий резонанс
    "presence_count": 0.4,
    "anchor_thought_count": 0.6,
    "clarify_count": 0.5,
    "confirm_count": 0.5,
    "observe_count": 0.4,
    "metaphor_count": 0.8,
    "symbol_count": 0.8,
    "story_count": 0.8,
    "spark_count": 0.7,
    "redirect_count": 0.4,
    "transfer_count": 0.5,
    "anger_count": 0.9,
    "outburst_count": 1.0,
    "pulse_count": 0.6,
}

WINDOW = 6  # последние N шагов

def compute_dialog_weight(session) -> float:
    if not hasattr(session, "recent_buckets"):
        return 0.0
    recent = list(session.recent_buckets)[-WINDOW:]
    if not recent:
        return 0.0
    w = sum(BUCKET_WEIGHTS.get(b, 0.5) for b in recent) / len(recent)
    # сгладим экспоненциально (опционально)
    session.dialog_weight = 0.6 * getattr(session, "dialog_weight", 0.0) + 0.4 * w
    return round(session.dialog_weight, 3)
```

---

# 2) density — «насколько тесно/часто мы взаимодействуем»

Без таймстемпов можно оценивать по структуре фрагментов и вопросам:

```python
def compute_density(session) -> float:
    # плотность как комбинация: доля ходов с вопросом + среднее число фрагментов/ход
    last = session.message_category_history[-WINDOW:] or []
    q_ratio = (sum(1 for x in last if x == "question") / max(1, len(last)))
    # если ты генеришь 3–4 фрагмента (start/core/question/end) — можно фиксировать факт наличия фрагментов
    frag_density = min(1.0, (len(last) / WINDOW))  # плоская аппроксимация
    return round(0.6 * q_ratio + 0.4 * frag_density, 3)
```

(если будешь хранить timestamps — можно сделать «сообщений в минуту» и подмешивать к формуле)

---

# 3) saturation — «мы застряли? пора сменить модальность?»

Сигналы:

* повторяемость (стрик) по bucket,
* низкая новизна (мало уникальных buckets),
* диалог давно без «нового типа» фразы,
* долго нет вопросов, или наоборот — долго только вопросы,
* dialog\_weight слишком высокий слишком долго (эмо-выхлоп).

```python
def compute_saturation(session) -> dict:
    recent = list(getattr(session, "recent_buckets", deque()))[-WINDOW:]
    if not recent:
        return {"score": 0.0, "reason": []}

    reasons = []

    # 1) стрики
    streak = 1
    for i in range(len(recent)-2, -1, -1):
        if recent[i] == recent[-1]:
            streak += 1
        else:
            break
    if streak >= 3:
        reasons.append(f"streak:{recent[-1]}x{streak}")

    # 2) низкая новизна
    uniq = len(set(recent))
    if uniq <= max(2, len(recent)//3):
        reasons.append("low_novelty")

    # 3) отсутствие вопросов
    last_types = session.message_category_history[-WINDOW:] or []
    if last_types and all(t != "question" for t in last_types):
        reasons.append("no_questions")
    if last_types and all(t == "question" for t in last_types) and len(last_types) >= 3:
        reasons.append("too_many_questions")

    # 4) перегрев
    dw = compute_dialog_weight(session)
    if dw >= 0.75:
        reasons.append("overheated")

    # агрегируем score
    base = 0.0
    weights = {
        "streak": 0.4,
        "low_novelty": 0.25,
        "no_questions": 0.15,
        "too_many_questions": 0.15,
        "overheated": 0.35,
    }
    for r in reasons:
        k = r.split(":")[0]
        base += weights.get(k, 0.1)

    return {"score": min(base, 1.0), "reason": reasons}
```

---

# 4) переключатель модальности (ритуалы/музыка/пауза)

Правило: если `saturation.score >= 0.6` — предложить мягкий сдвиг. Один раз в `cooldown` (чтобы не спамить).

```python
from time import time

SHIFT_COOLDOWN_SEC = 90

def decide_modality_shift(session) -> dict:
    sat = compute_saturation(session)
    now = time()
    last_shift = getattr(session, "last_shift_ts", 0)
    cooldown_ok = (now - last_shift) > SHIFT_COOLDOWN_SEC

    if sat["score"] >= 0.6 and cooldown_ok:
        session.last_shift_ts = now
        # подберём тип сдвига по причине
        reasons = set(r.split(":")[0] for r in sat["reason"])
        if "overheated" in reasons or "streak" in reasons:
            action = ("micro_ritual",
                      "Давай сделаем один вдох вместе, а потом я кину тебе маленькую вещь на вдохновение?")
        elif "no_questions" in reasons:
            action = ("gentle_question",
                      "Хочешь один короткий вопрос — чтобы нащупать следующую точку?")
        elif "too_many_questions" in reasons or "low_novelty" in reasons:
            action = ("music_or_image",
                      "Могу прислать трек на это чувство — сменить плоскость на пару минут?")
        else:
            action = ("soft_exit",
                      "Можем взять маленькую паузу. Я рядом — вернёмся, когда почувствуешь.")
        return {"shift": True, "kind": action[0], "prompt": action[1], "meta": sat}

    return {"shift": False, "meta": sat}
```

> если хочешь «музыку» — лучше сначала спросить согласие; и держать белый список ссылок/источников.

---

# как это складывается вместе

* на каждом ходе:

  1. выбираешь фрагменты, обновляешь counters/`recent_buckets`;
  2. считаешь `dialog_weight`, `density`;
  3. вызываешь `decide_modality_shift(session)`;
  4. если `shift` → добавляешь мягкую приглашалку вместо очередного однотипного фрагмента.

---

## коротко: зачем это всё

* **dialog\_weight** даёт «температуру» беседы;
* **density** — ритм (сколько «движения» и вопросов);
* **saturation** — сигнал «мы ходим по кругу»;
* **shift** — бережный выход из круга (песня, дыхание, вопрос, пауза), не ломая поток.

Это уже даст тебе стабильный такт: разговоры перестанут залипать в одной краске, а Виктор начнёт вовремя предлагать сменить плоскость — без насилия и без случайных шума.
